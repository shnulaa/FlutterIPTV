# Catchup åŠŸèƒ½å¹³å°å·®å¼‚åŒ–è®¾è®¡æ–‡æ¡£

## 1. å¹³å°æ¦‚è¿°

æœ¬åº”ç”¨æ”¯æŒä¸‰ä¸ªä¸»è¦å¹³å°ï¼š
- **Android TV**ï¼šå¤§å±ç”µè§†ï¼Œé¥æ§å™¨æ“ä½œ
- **Mobile**ï¼ˆAndroid/iOSï¼‰ï¼šæ‰‹æœº/å¹³æ¿ï¼Œè§¦æ‘¸æ“ä½œ
- **Windows**ï¼šæ¡Œé¢åº”ç”¨ï¼Œé¼ æ ‡é”®ç›˜æ“ä½œ

æ¯ä¸ªå¹³å°åœ¨äº¤äº’æ–¹å¼ã€UI å¸ƒå±€ã€æ€§èƒ½ä¼˜åŒ–æ–¹é¢éƒ½æœ‰æ˜¾è‘—å·®å¼‚ã€‚

---

## 2. å¹³å°å·®å¼‚å¯¹æ¯”è¡¨

| ç‰¹æ€§ | Android TV | Mobile | Windows |
|------|-----------|--------|---------|
| **è¾“å…¥æ–¹å¼** | é¥æ§å™¨ï¼ˆæ–¹å‘é”®+OKï¼‰ | è§¦æ‘¸å± | é¼ æ ‡+é”®ç›˜ |
| **å±å¹•å°ºå¯¸** | å¤§å±ï¼ˆ40-75å¯¸ï¼‰ | å°å±ï¼ˆ4-7å¯¸ï¼‰ | ä¸­å¤§å±ï¼ˆ13-27å¯¸ï¼‰ |
| **å±å¹•æ–¹å‘** | æ¨ªå±å›ºå®š | ç«–å±/æ¨ªå±åˆ‡æ¢ | æ¨ªå±ä¸ºä¸» |
| **ç„¦ç‚¹ç®¡ç†** | å¿…éœ€ï¼ˆé¥æ§å™¨å¯¼èˆªï¼‰ | ä¸éœ€è¦ | å¯é€‰ |
| **æ‰‹åŠ¿æ”¯æŒ** | æ—  | ä¸°å¯Œ | æœ‰é™ |
| **å¤šçª—å£** | ä¸æ”¯æŒ | åˆ†å± | å®Œå…¨æ”¯æŒ |
| **æ€§èƒ½è¦æ±‚** | ä¸­ç­‰ | ä½ï¼ˆçœç”µï¼‰ | é«˜ |
| **ç½‘ç»œç¯å¢ƒ** | WiFi ç¨³å®š | WiFi/4G/5G | WiFi/æœ‰çº¿ |
| **å­˜å‚¨ç©ºé—´** | è¾ƒå¤§ | æœ‰é™ | å……è¶³ |
| **æ’­æ”¾å™¨** | ExoPlayer | ExoPlayer/AVPlayer | Media Foundation |

---

## 3. Android TV è¯¦ç»†è®¾è®¡

### 3.1 UI å¸ƒå±€ç‰¹ç‚¹


**å¸ƒå±€åŸåˆ™ï¼š**
- 10-foot UI è®¾è®¡ï¼ˆ3ç±³è§‚çœ‹è·ç¦»ï¼‰
- å¤§å­—ä½“ã€å¤§å›¾æ ‡ã€å¤§é—´è·
- ç„¦ç‚¹æ¸…æ™°å¯è§
- é¿å…å°å…ƒç´ å’Œå¤æ‚äº¤äº’

**Catchup ç•Œé¢å¸ƒå±€ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [CCTV1]                                    [è®¾ç½®] [æ”¶è—]  â”‚  â† é¡¶éƒ¨æ ï¼ˆç„¦ç‚¹åŒºåŸŸ1ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚                    è§†é¢‘æ’­æ”¾åŒºåŸŸ                             â”‚
â”‚                    (16:9 å…¨å±)                             â”‚
â”‚                                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ğŸ”´ ç›´æ’­]  [ğŸ“º å›çœ‹]                                      â”‚  â† æ¨¡å¼åˆ‡æ¢ï¼ˆç„¦ç‚¹åŒºåŸŸ2ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ–°é—»è”æ’­  19:00-19:30                                     â”‚  â† èŠ‚ç›®ä¿¡æ¯ï¼ˆç„¦ç‚¹åŒºåŸŸ3ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â—€ 2æœˆ27æ—¥  |  2æœˆ28æ—¥  |  2æœˆ29æ—¥ â–¶                      â”‚  â† æ—¥æœŸé€‰æ‹©ï¼ˆç„¦ç‚¹åŒºåŸŸ4ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [æ—¶é—´è½´ - æ¨ªå‘æ»šåŠ¨]                                        â”‚  â† æ—¶é—´è½´ï¼ˆç„¦ç‚¹åŒºåŸŸ5ï¼‰
â”‚  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”                          â”‚
â”‚  â”‚æ—©é—´â”‚  â”‚åˆé—´â”‚  â”‚æ–°é—»â”‚  â”‚æ™šé—´â”‚                           â”‚
â”‚  â”‚æ–°é—»â”‚  â”‚æ–°é—»â”‚  â”‚è”æ’­â”‚  â”‚æ–°é—»â”‚                           â”‚
â”‚  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [èŠ‚ç›®åˆ—è¡¨ - çºµå‘æ»šåŠ¨]                                      â”‚  â† èŠ‚ç›®åˆ—è¡¨ï¼ˆç„¦ç‚¹åŒºåŸŸ6ï¼‰
â”‚  â–¶ 19:00-19:30  æ–°é—»è”æ’­                                   â”‚
â”‚    18:00-19:00  ç»¼åˆæ–°é—»                                   â”‚
â”‚    17:00-18:00  ä»Šæ—¥è¯´æ³•                                   â”‚
â”‚    16:00-17:00  ç¬¬ä¸€æ—¶é—´                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ç„¦ç‚¹å¯¼èˆªè®¾è®¡

**ç„¦ç‚¹æµè½¬è§„åˆ™ï¼š**

```
ä¸Šé”®ï¼šå½“å‰åŒºåŸŸ â†’ ä¸Šä¸€ä¸ªåŒºåŸŸ
ä¸‹é”®ï¼šå½“å‰åŒºåŸŸ â†’ ä¸‹ä¸€ä¸ªåŒºåŸŸ
å·¦é”®ï¼šåŒºåŸŸå†…å‘å·¦ / ä¸Šä¸€ä¸ªèŠ‚ç›®
å³é”®ï¼šåŒºåŸŸå†…å‘å³ / ä¸‹ä¸€ä¸ªèŠ‚ç›®
OKé”®ï¼šé€‰æ‹©/æ’­æ”¾
è¿”å›é”®ï¼šè¿”å›ä¸Šä¸€çº§ / è¿”å›ç›´æ’­
```

**ç„¦ç‚¹åŒºåŸŸä¼˜å…ˆçº§ï¼š**
1. æ’­æ”¾æ§åˆ¶ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. æ¨¡å¼åˆ‡æ¢
3. æ—¥æœŸé€‰æ‹©
4. æ—¶é—´è½´
5. èŠ‚ç›®åˆ—è¡¨
6. é¡¶éƒ¨å·¥å…·æ 


### 3.3 é¥æ§å™¨æŒ‰é”®æ˜ å°„

```dart
// TV é¥æ§å™¨æŒ‰é”®å¤„ç†ä¼ªä»£ç 
class TvCatchupController {
  FocusNode currentFocus;
  List<FocusNode> focusNodes;
  
  void handleKeyEvent(KeyEvent event) {
    switch (event.logicalKey) {
      case LogicalKeyboardKey.arrowUp:
        moveFocusUp();
        break;
      case LogicalKeyboardKey.arrowDown:
        moveFocusDown();
        break;
      case LogicalKeyboardKey.arrowLeft:
        handleLeftKey();
        break;
      case LogicalKeyboardKey.arrowRight:
        handleRightKey();
        break;
      case LogicalKeyboardKey.select:  // OK é”®
        handleOkKey();
        break;
      case LogicalKeyboardKey.goBack:  // è¿”å›é”®
        handleBackKey();
        break;
      case LogicalKeyboardKey.mediaPlayPause:
        togglePlayPause();
        break;
    }
  }
  
  void handleLeftKey() {
    if (currentFocus == timelineFocus) {
      // æ—¶é—´è½´å‘å·¦æ»šåŠ¨
      scrollTimeline(direction: -1);
    } else if (currentFocus == dateFocus) {
      // åˆ‡æ¢åˆ°å‰ä¸€å¤©
      selectPreviousDate();
    } else if (currentFocus == programListFocus) {
      // æ’­æ”¾ä¸Šä¸€ä¸ªèŠ‚ç›®
      playPreviousProgram();
    }
  }
  
  void handleRightKey() {
    if (currentFocus == timelineFocus) {
      // æ—¶é—´è½´å‘å³æ»šåŠ¨
      scrollTimeline(direction: 1);
    } else if (currentFocus == dateFocus) {
      // åˆ‡æ¢åˆ°åä¸€å¤©
      selectNextDate();
    } else if (currentFocus == programListFocus) {
      // æ’­æ”¾ä¸‹ä¸€ä¸ªèŠ‚ç›®
      playNextProgram();
    }
  }
  
  void handleOkKey() {
    if (currentFocus == programListFocus) {
      // æ’­æ”¾é€‰ä¸­çš„èŠ‚ç›®
      playSelectedProgram();
    } else if (currentFocus == timelineFocus) {
      // æ˜¾ç¤ºèŠ‚ç›®è¯¦æƒ…
      showProgramDetails();
    } else if (currentFocus == modeSwitchFocus) {
      // åˆ‡æ¢ç›´æ’­/å›çœ‹æ¨¡å¼
      toggleMode();
    }
  }
  
  void handleBackKey() {
    if (isInCatchupMode) {
      // è¿”å›ç›´æ’­
      returnToLive();
    } else {
      // é€€å‡ºæ’­æ”¾å™¨
      exitPlayer();
    }
  }
}
```

### 3.4 æ€§èƒ½ä¼˜åŒ–ï¼ˆTVï¼‰

```dart
// TV ç‰¹å®šä¼˜åŒ–
class TvOptimizations {
  // 1. é¢„åŠ è½½ç›¸é‚»èŠ‚ç›®
  void preloadAdjacentPrograms() {
    final currentIndex = getCurrentProgramIndex();
    if (currentIndex > 0) {
      preloadProgram(currentIndex - 1);  // ä¸Šä¸€ä¸ª
    }
    if (currentIndex < programList.length - 1) {
      preloadProgram(currentIndex + 1);  // ä¸‹ä¸€ä¸ª
    }
  }
  
  // 2. å›¾ç‰‡ç¼“å­˜ç­–ç•¥ï¼ˆTV å†…å­˜è¾ƒå¤§ï¼‰
  void configureTvImageCache() {
    PaintingBinding.instance.imageCache.maximumSize = 200;  // å¢åŠ ç¼“å­˜
    PaintingBinding.instance.imageCache.maximumSizeBytes = 100 << 20;  // 100MB
  }
  
  // 3. åˆ—è¡¨è™šæ‹ŸåŒ–ï¼ˆå¤§å±æ˜¾ç¤ºæ›´å¤šé¡¹ï¼‰
  Widget buildProgramList() {
    return ListView.builder(
      itemCount: programs.length,
      itemExtent: 80.0,  // TV ä¸Šæ›´å¤§çš„é¡¹é«˜åº¦
      cacheExtent: 800.0,  // é¢„æ¸²æŸ“æ›´å¤šé¡¹
      itemBuilder: (context, index) {
        return TvProgramListItem(program: programs[index]);
      },
    );
  }
  
  // 4. ç„¦ç‚¹åŠ¨ç”»ä¼˜åŒ–
  Widget buildFocusableItem(Widget child) {
    return Focus(
      onFocusChange: (hasFocus) {
        // ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿçš„åŠ¨ç”»
        if (hasFocus) {
          animateScale(from: 1.0, to: 1.1, duration: 150);
        }
      },
      child: child,
    );
  }
}
```

---

## 4. Mobile è¯¦ç»†è®¾è®¡

### 4.1 UI å¸ƒå±€ç‰¹ç‚¹

**å¸ƒå±€åŸåˆ™ï¼š**
- é€‚é…å°å±å¹•ï¼ˆ4-7å¯¸ï¼‰
- æ”¯æŒç«–å±å’Œæ¨ªå±
- è§¦æ‘¸å‹å¥½ï¼ˆæœ€å°ç‚¹å‡»åŒºåŸŸ 44x44dpï¼‰
- å•æ‰‹æ“ä½œä¼˜åŒ–

**ç«–å±å¸ƒå±€ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [<] CCTV1      [â‹®]   â”‚  â† é¡¶éƒ¨æ 
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      â”‚
â”‚   è§†é¢‘æ’­æ”¾åŒºåŸŸ        â”‚
â”‚   (16:9)             â”‚
â”‚                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”´ç›´æ’­ | ğŸ“ºå›çœ‹       â”‚  â† æ ‡ç­¾åˆ‡æ¢
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ–°é—»è”æ’­             â”‚
â”‚ 19:00-19:30          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â—€ 2/28 â–¶            â”‚  â† æ—¥æœŸé€‰æ‹©ï¼ˆç´§å‡‘ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [æ—¶é—´è½´ - æ¨ªå‘æ»šåŠ¨]   â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [èŠ‚ç›®åˆ—è¡¨]           â”‚
â”‚ â–¶ 19:00 æ–°é—»è”æ’­     â”‚
â”‚   18:00 ç»¼åˆæ–°é—»     â”‚
â”‚   17:00 ä»Šæ—¥è¯´æ³•     â”‚
â”‚   16:00 ç¬¬ä¸€æ—¶é—´     â”‚
â”‚   ...                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¨ªå±å¸ƒå±€ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                            â”‚
â”‚          è§†é¢‘æ’­æ”¾åŒºåŸŸï¼ˆå…¨å±ï¼‰               â”‚
â”‚                                            â”‚
â”‚  [æ§åˆ¶æ æ‚¬æµ®åœ¨åº•éƒ¨]                         â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚
â”‚  [<] 19:00-19:30 æ–°é—»è”æ’­    [å›çœ‹] [â‹®]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### 4.2 æ‰‹åŠ¿äº¤äº’è®¾è®¡

```dart
// Mobile æ‰‹åŠ¿å¤„ç†ä¼ªä»£ç 
class MobileCatchupGestures {
  
  // 1. è§†é¢‘åŒºåŸŸæ‰‹åŠ¿
  Widget buildVideoGestureDetector() {
    return GestureDetector(
      onTap: () {
        // å•å‡»ï¼šæ˜¾ç¤º/éšè—æ§åˆ¶æ 
        toggleControlsVisibility();
      },
      onDoubleTap: () {
        // åŒå‡»ï¼šæ’­æ”¾/æš‚åœ
        togglePlayPause();
      },
      onHorizontalDragUpdate: (details) {
        // å·¦å³æ»‘åŠ¨ï¼šå¿«è¿›/å¿«é€€
        if (details.delta.dx > 0) {
          seekForward(seconds: 10);
        } else {
          seekBackward(seconds: 10);
        }
      },
      onVerticalDragUpdate: (details) {
        final screenWidth = MediaQuery.of(context).size.width;
        final isLeftSide = details.localPosition.dx < screenWidth / 2;
        
        if (isLeftSide) {
          // å·¦ä¾§ä¸Šä¸‹æ»‘åŠ¨ï¼šè°ƒèŠ‚äº®åº¦
          adjustBrightness(details.delta.dy);
        } else {
          // å³ä¾§ä¸Šä¸‹æ»‘åŠ¨ï¼šè°ƒèŠ‚éŸ³é‡
          adjustVolume(details.delta.dy);
        }
      },
      onLongPress: () {
        // é•¿æŒ‰ï¼šæ˜¾ç¤ºä¸Šä¸‹æ–‡èœå•
        showContextMenu();
      },
      child: VideoPlayer(),
    );
  }
  
  // 2. æ—¶é—´è½´æ‰‹åŠ¿
  Widget buildTimelineGesture() {
    return GestureDetector(
      onHorizontalDragUpdate: (details) {
        // æ‹–åŠ¨æ—¶é—´è½´
        scrollTimeline(details.delta.dx);
      },
      onTapUp: (details) {
        // ç‚¹å‡»æ—¶é—´è½´ä¸Šçš„èŠ‚ç›®
        final program = getProgramAtPosition(details.localPosition);
        if (program != null) {
          showProgramPreview(program);
        }
      },
      child: TimelineWidget(),
    );
  }
  
  // 3. èŠ‚ç›®åˆ—è¡¨æ‰‹åŠ¿
  Widget buildProgramListGesture() {
    return ListView.builder(
      itemCount: programs.length,
      itemBuilder: (context, index) {
        return Dismissible(
          key: Key(programs[index].id.toString()),
          background: Container(
            color: Colors.blue,
            child: Icon(Icons.favorite),
          ),
          secondaryBackground: Container(
            color: Colors.red,
            child: Icon(Icons.delete),
          ),
          onDismissed: (direction) {
            if (direction == DismissDirection.startToEnd) {
              // å³æ»‘ï¼šæ·»åŠ åˆ°æ”¶è—
              addToFavorites(programs[index]);
            } else {
              // å·¦æ»‘ï¼šåˆ é™¤å†å²
              removeFromHistory(programs[index]);
            }
          },
          child: ProgramListItem(
            program: programs[index],
            onTap: () => playProgram(programs[index]),
            onLongPress: () => showProgramOptions(programs[index]),
          ),
        );
      },
    );
  }
  
  // 4. ä¸‹æ‹‰åˆ·æ–°
  Widget buildRefreshableList() {
    return RefreshIndicator(
      onRefresh: () async {
        await refreshEpgData();
      },
      child: buildProgramListGesture(),
    );
  }
}
```

### 4.3 å“åº”å¼å¸ƒå±€

```dart
// Mobile å“åº”å¼è®¾è®¡
class MobileResponsiveLayout {
  
  Widget build(BuildContext context) {
    final orientation = MediaQuery.of(context).orientation;
    final screenSize = MediaQuery.of(context).size;
    
    if (orientation == Orientation.portrait) {
      return buildPortraitLayout();
    } else {
      return buildLandscapeLayout();
    }
  }
  
  Widget buildPortraitLayout() {
    return Column(
      children: [
        // é¡¶éƒ¨æ 
        AppBar(height: 56),
        // è§†é¢‘æ’­æ”¾å™¨ï¼ˆ16:9ï¼‰
        AspectRatio(
          aspectRatio: 16 / 9,
          child: VideoPlayer(),
        ),
        // æ¨¡å¼åˆ‡æ¢æ ‡ç­¾
        TabBar(tabs: ['ç›´æ’­', 'å›çœ‹']),
        // èŠ‚ç›®ä¿¡æ¯å¡ç‰‡
        ProgramInfoCard(height: 80),
        // æ—¥æœŸé€‰æ‹©å™¨ï¼ˆç´§å‡‘ï¼‰
        CompactDatePicker(height: 50),
        // æ—¶é—´è½´ï¼ˆæ¨ªå‘æ»šåŠ¨ï¼‰
        TimelineWidget(height: 100),
        // èŠ‚ç›®åˆ—è¡¨ï¼ˆå æ®å‰©ä½™ç©ºé—´ï¼‰
        Expanded(
          child: ProgramList(),
        ),
      ],
    );
  }
  
  Widget buildLandscapeLayout() {
    return Stack(
      children: [
        // å…¨å±è§†é¢‘
        Positioned.fill(
          child: VideoPlayer(),
        ),
        // åº•éƒ¨æ§åˆ¶æ ï¼ˆè‡ªåŠ¨éšè—ï¼‰
        Positioned(
          bottom: 0,
          left: 0,
          right: 0,
          child: AnimatedOpacity(
            opacity: controlsVisible ? 1.0 : 0.0,
            duration: Duration(milliseconds: 300),
            child: BottomControlBar(),
          ),
        ),
        // ä¾§è¾¹èŠ‚ç›®åˆ—è¡¨ï¼ˆå¯æ»‘å‡ºï¼‰
        Positioned(
          right: showSidebar ? 0 : -300,
          top: 0,
          bottom: 0,
          child: AnimatedContainer(
            duration: Duration(milliseconds: 300),
            width: 300,
            child: ProgramSidebar(),
          ),
        ),
      ],
    );
  }
}
```

### 4.4 æ€§èƒ½ä¼˜åŒ–ï¼ˆMobileï¼‰

```dart
// Mobile ç‰¹å®šä¼˜åŒ–ï¼ˆçœç”µã€çœæµé‡ï¼‰
class MobileOptimizations {
  
  // 1. å›¾ç‰‡åŠ è½½ä¼˜åŒ–
  void configureImageLoading() {
    // æ ¹æ®ç½‘ç»œçŠ¶æ€è°ƒæ•´å›¾ç‰‡è´¨é‡
    if (isOnMobileData) {
      imageQuality = ImageQuality.low;
      enableImageCompression = true;
    } else {
      imageQuality = ImageQuality.high;
      enableImageCompression = false;
    }
  }
  
  // 2. EPG æ•°æ®åŠ è½½ç­–ç•¥
  Future<void> loadEpgData() async {
    // ä»…åŠ è½½å½“å‰æ—¥æœŸ Â± 1 å¤©
    final today = DateTime.now();
    final yesterday = today.subtract(Duration(days: 1));
    final tomorrow = today.add(Duration(days: 1));
    
    await loadEpgForDateRange(yesterday, tomorrow);
  }
  
  // 3. åˆ—è¡¨ä¼˜åŒ–ï¼ˆå°å±æ˜¾ç¤ºè¾ƒå°‘é¡¹ï¼‰
  Widget buildOptimizedList() {
    return ListView.builder(
      itemCount: programs.length,
      itemExtent: 60.0,  // Mobile ä¸Šè¾ƒå°çš„é¡¹é«˜åº¦
      cacheExtent: 300.0,  // è¾ƒå°çš„é¢„æ¸²æŸ“èŒƒå›´
      addAutomaticKeepAlives: false,  // ä¸ä¿æŒçŠ¶æ€
      addRepaintBoundaries: true,  // ä¼˜åŒ–é‡ç»˜
      itemBuilder: (context, index) {
        return MobileProgramListItem(program: programs[index]);
      },
    );
  }
  
  // 4. åå°æ’­æ”¾ä¼˜åŒ–
  void configureBackgroundPlayback() {
    // è¿›å…¥åå°æ—¶é™ä½è§†é¢‘è´¨é‡
    AppLifecycleState.paused.listen(() {
      if (isPlayingCatchup) {
        reduceVideoQuality();
      }
    });
    
    // è¿”å›å‰å°æ—¶æ¢å¤
    AppLifecycleState.resumed.listen(() {
      restoreVideoQuality();
    });
  }
  
  // 5. ç”µæ± ä¼˜åŒ–
  void enableBatterySaving() {
    // é™ä½åˆ·æ–°ç‡
    if (batteryLevel < 20) {
      disableAnimations();
      reducePollingFrequency();
    }
  }
}
```

---

## 5. Windows è¯¦ç»†è®¾è®¡

### 5.1 UI å¸ƒå±€ç‰¹ç‚¹

**å¸ƒå±€åŸåˆ™ï¼š**
- å……åˆ†åˆ©ç”¨å¤§å±ç©ºé—´
- æ”¯æŒçª—å£è°ƒæ•´å¤§å°
- é¼ æ ‡æ‚¬åœäº¤äº’
- é”®ç›˜å¿«æ·é”®ä¸°å¯Œ

**Windows å¸ƒå±€ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [<] CCTV1                    [æœ€å°åŒ–] [æœ€å¤§åŒ–] [å…³é—­]         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                            â”‚  [æ—¥æœŸé€‰æ‹©å™¨]                    â”‚
â”‚                            â”‚  â—€ 2æœˆ27æ—¥ | 2æœˆ28æ—¥ | 2æœˆ29æ—¥ â–¶â”‚
â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                            â”‚  [èŠ‚ç›®åˆ—è¡¨ - å¯è°ƒæ•´å®½åº¦]         â”‚
â”‚      è§†é¢‘æ’­æ”¾åŒºåŸŸ           â”‚  â–¶ 19:00-19:30  æ–°é—»è”æ’­        â”‚
â”‚      (å¯è°ƒæ•´å¤§å°)           â”‚    18:00-19:00  ç»¼åˆæ–°é—»        â”‚
â”‚                            â”‚    17:00-18:00  ä»Šæ—¥è¯´æ³•        â”‚
â”‚                            â”‚    16:00-17:00  ç¬¬ä¸€æ—¶é—´        â”‚
â”‚                            â”‚    15:00-16:00  æ–°é—»ç›´æ’­é—´      â”‚
â”‚                            â”‚    ...                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [æ’­æ”¾æ§åˆ¶æ ]                                                 â”‚
â”‚  â–¶ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” ğŸ”Šâ”‚
â”‚  19:00-19:30 æ–°é—»è”æ’­                    [ğŸ”´è¿”å›ç›´æ’­] [âš™ï¸]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### 5.2 é¼ æ ‡å’Œé”®ç›˜äº¤äº’

```dart
// Windows äº¤äº’å¤„ç†ä¼ªä»£ç 
class WindowsCatchupController {
  
  // 1. é¼ æ ‡æ‚¬åœæ•ˆæœ
  Widget buildHoverableItem(Program program) {
    return MouseRegion(
      onEnter: (_) {
        // æ˜¾ç¤ºèŠ‚ç›®é¢„è§ˆ
        showProgramPreview(program);
        // é«˜äº®æ˜¾ç¤º
        setState(() => hoveredProgram = program);
      },
      onExit: (_) {
        // éšè—é¢„è§ˆ
        hidePreview();
        setState(() => hoveredProgram = null);
      },
      child: GestureDetector(
        onTap: () => playProgram(program),
        onSecondaryTap: () => showContextMenu(program),
        child: ProgramListItem(
          program: program,
          isHovered: hoveredProgram == program,
        ),
      ),
    );
  }
  
  // 2. é”®ç›˜å¿«æ·é”®
  Widget buildKeyboardShortcuts() {
    return Shortcuts(
      shortcuts: {
        LogicalKeySet(LogicalKeyboardKey.space): PlayPauseIntent(),
        LogicalKeySet(LogicalKeyboardKey.arrowLeft): SeekBackwardIntent(),
        LogicalKeySet(LogicalKeyboardKey.arrowRight): SeekForwardIntent(),
        LogicalKeySet(LogicalKeyboardKey.arrowUp): VolumeUpIntent(),
        LogicalKeySet(LogicalKeyboardKey.arrowDown): VolumeDownIntent(),
        LogicalKeySet(LogicalKeyboardKey.keyF): FullscreenIntent(),
        LogicalKeySet(LogicalKeyboardKey.escape): ExitFullscreenIntent(),
        LogicalKeySet(LogicalKeyboardKey.keyL): ReturnToLiveIntent(),
        LogicalKeySet(LogicalKeyboardKey.keyM): MuteIntent(),
        LogicalKeySet(LogicalKeyboardKey.keyN): NextProgramIntent(),
        LogicalKeySet(LogicalKeyboardKey.keyP): PreviousProgramIntent(),
        LogicalKeySet(LogicalKeyboardKey.control, LogicalKeyboardKey.keyF): SearchIntent(),
      },
      child: Actions(
        actions: {
          PlayPauseIntent: CallbackAction(onInvoke: (_) => togglePlayPause()),
          SeekBackwardIntent: CallbackAction(onInvoke: (_) => seekBackward(10)),
          SeekForwardIntent: CallbackAction(onInvoke: (_) => seekForward(10)),
          // ... å…¶ä»–åŠ¨ä½œ
        },
        child: Focus(
          autofocus: true,
          child: CatchupPlayerWidget(),
        ),
      ),
    );
  }
  
  // 3. å³é”®èœå•
  void showContextMenu(Program program) {
    showMenu(
      context: context,
      position: mousePosition,
      items: [
        PopupMenuItem(
          child: Text('æ’­æ”¾'),
          onTap: () => playProgram(program),
        ),
        PopupMenuItem(
          child: Text('æ·»åŠ åˆ°æ”¶è—'),
          onTap: () => addToFavorites(program),
        ),
        PopupMenuItem(
          child: Text('æŸ¥çœ‹è¯¦æƒ…'),
          onTap: () => showProgramDetails(program),
        ),
        PopupMenuItem(
          child: Text('åˆ†äº«'),
          onTap: () => shareProgram(program),
        ),
        PopupMenuDivider(),
        PopupMenuItem(
          child: Text('å¤åˆ¶é“¾æ¥'),
          onTap: () => copyProgramLink(program),
        ),
      ],
    );
  }
  
  // 4. æ»šè½®æ§åˆ¶
  Widget buildScrollableTimeline() {
    return Listener(
      onPointerSignal: (event) {
        if (event is PointerScrollEvent) {
          // é¼ æ ‡æ»šè½®æ§åˆ¶æ—¶é—´è½´æ»šåŠ¨
          scrollTimeline(event.scrollDelta.dy);
        }
      },
      child: TimelineWidget(),
    );
  }
}
```

### 5.3 çª—å£ç®¡ç†

```dart
// Windows çª—å£ç®¡ç†
class WindowsWindowManager {
  
  // 1. çª—å£å¤§å°è°ƒæ•´
  void handleWindowResize(Size newSize) {
    if (newSize.width < 800) {
      // å°çª—å£ï¼šéšè—ä¾§è¾¹æ 
      setState(() => showSidebar = false);
    } else {
      // å¤§çª—å£ï¼šæ˜¾ç¤ºä¾§è¾¹æ 
      setState(() => showSidebar = true);
    }
    
    // è°ƒæ•´å¸ƒå±€
    updateLayout(newSize);
  }
  
  // 2. åˆ†å±æ”¯æŒ
  Widget buildResizableLayout() {
    return Row(
      children: [
        // è§†é¢‘åŒºåŸŸï¼ˆå¯è°ƒæ•´ï¼‰
        Expanded(
          flex: videoFlex,
          child: VideoPlayer(),
        ),
        // åˆ†éš”æ¡
        MouseRegion(
          cursor: SystemMouseCursors.resizeColumn,
          child: GestureDetector(
            onHorizontalDragUpdate: (details) {
              adjustSplitRatio(details.delta.dx);
            },
            child: Container(
              width: 4,
              color: Colors.grey,
            ),
          ),
        ),
        // èŠ‚ç›®åˆ—è¡¨åŒºåŸŸï¼ˆå¯è°ƒæ•´ï¼‰
        Expanded(
          flex: sidebarFlex,
          child: ProgramList(),
        ),
      ],
    );
  }
  
  // 3. å¤šçª—å£æ”¯æŒ
  void openProgramInNewWindow(Program program) {
    // Windows æ”¯æŒå¤šçª—å£
    WindowManager.createWindow(
      title: program.title,
      width: 800,
      height: 600,
      child: CatchupPlayerWindow(program: program),
    );
  }
  
  // 4. ç”»ä¸­ç”»æ¨¡å¼
  void enablePictureInPicture() {
    WindowManager.setPictureInPictureMode(
      enabled: true,
      aspectRatio: 16 / 9,
      onClose: () => exitPictureInPicture(),
    );
  }
}
```

### 5.4 æ€§èƒ½ä¼˜åŒ–ï¼ˆWindowsï¼‰

```dart
// Windows ç‰¹å®šä¼˜åŒ–ï¼ˆå……åˆ†åˆ©ç”¨ç¡¬ä»¶ï¼‰
class WindowsOptimizations {
  
  // 1. ç¡¬ä»¶åŠ é€Ÿ
  void enableHardwareAcceleration() {
    // ä½¿ç”¨ GPU åŠ é€Ÿè§†é¢‘è§£ç 
    videoPlayer.setRenderMode(RenderMode.hardwareAcceleration);
    
    // å¯ç”¨ DirectX æ¸²æŸ“
    enableDirectXRendering();
  }
  
  // 2. å¤šçº¿ç¨‹å¤„ç†
  Future<void> loadEpgDataParallel() async {
    // ä½¿ç”¨ Isolate å¹¶è¡ŒåŠ è½½ EPG
    final results = await Future.wait([
      compute(loadEpgForChannel, channel1),
      compute(loadEpgForChannel, channel2),
      compute(loadEpgForChannel, channel3),
    ]);
    
    mergeEpgResults(results);
  }
  
  // 3. ç¼“å­˜ç­–ç•¥ï¼ˆWindows å­˜å‚¨ç©ºé—´å¤§ï¼‰
  void configureWindowsCache() {
    // æ›´å¤§çš„å›¾ç‰‡ç¼“å­˜
    PaintingBinding.instance.imageCache.maximumSize = 500;
    PaintingBinding.instance.imageCache.maximumSizeBytes = 200 << 20;  // 200MB
    
    // ç¼“å­˜æ›´å¤š EPG æ•°æ®ï¼ˆ7å¤©ï¼‰
    epgCacheDays = 7;
    
    // é¢„åŠ è½½è§†é¢‘ç‰‡æ®µ
    enableVideoPreloading = true;
  }
  
  // 4. åˆ—è¡¨è™šæ‹ŸåŒ–ï¼ˆå¤§å±æ˜¾ç¤ºæ›´å¤šï¼‰
  Widget buildVirtualizedList() {
    return ListView.builder(
      itemCount: programs.length,
      itemExtent: 70.0,
      cacheExtent: 1000.0,  // é¢„æ¸²æŸ“æ›´å¤š
      itemBuilder: (context, index) {
        return WindowsProgramListItem(program: programs[index]);
      },
    );
  }
  
  // 5. ç½‘ç»œä¼˜åŒ–
  void configureNetworking() {
    // ä½¿ç”¨æ›´å¤§çš„ç¼“å†²åŒº
    httpClient.bufferSize = 8 * 1024 * 1024;  // 8MB
    
    // å¹¶å‘è¯·æ±‚æ•°
    httpClient.maxConcurrentRequests = 10;
    
    // å¯ç”¨ HTTP/2
    httpClient.enableHttp2 = true;
  }
}
```

---

## 6. å¹³å°ç‰¹å®šä¼ªä»£ç å®ç°

### 6.1 Catchup URL æ„å»ºå™¨ï¼ˆé€šç”¨ï¼‰

```dart
class CatchupUrlBuilder {
  
  String buildCatchupUrl({
    required Channel channel,
    required EpgProgram program,
  }) {
    if (!channel.catchupEnabled || channel.catchupSource == null) {
      throw Exception('Catchup not enabled for this channel');
    }
    
    final catchupType = channel.catchupType ?? 'append';
    final catchupSource = channel.catchupSource!;
    final originalUrl = channel.url;
    
    switch (catchupType) {
      case 'append':
        return buildAppendUrl(originalUrl, catchupSource, program);
      case 'default':
        return buildDefaultUrl(catchupSource, program);
      case 'shift':
        return buildShiftUrl(originalUrl, catchupSource, program);
      case 'flussonic':
        return buildFlussonicUrl(originalUrl, catchupSource, program);
      case 'xc':
        return buildXcUrl(originalUrl, catchupSource, program);
      default:
        throw Exception('Unknown catchup type: $catchupType');
    }
  }
  
  String buildAppendUrl(
    String originalUrl,
    String catchupSource,
    EpgProgram program,
  ) {
    // æ›¿æ¢å ä½ç¬¦
    final processedSource = replacePlaceholders(catchupSource, program);
    
    // è¿½åŠ åˆ°åŸå§‹ URL
    final separator = originalUrl.contains('?') ? '&' : '?';
    return originalUrl + separator + processedSource.substring(1);  // å»æ‰å¼€å¤´çš„ ?
  }
  
  String buildDefaultUrl(
    String catchupSource,
    EpgProgram program,
  ) {
    // å®Œå…¨æ›¿æ¢ URL
    return replacePlaceholders(catchupSource, program);
  }
  
  String replacePlaceholders(String template, EpgProgram program) {
    String result = template;
    
    // æ—¶é—´æˆ³å ä½ç¬¦
    result = result.replaceAll(
      r'${(b)timestamp}',
      program.startTime.toString(),
    );
    result = result.replaceAll(
      r'${(e)timestamp}',
      program.endTime.toString(),
    );
    
    // æ—¥æœŸæ—¶é—´æ ¼å¼å ä½ç¬¦
    final startDateTime = DateTime.fromMillisecondsSinceEpoch(
      program.startTime * 1000,
    );
    final endDateTime = DateTime.fromMillisecondsSinceEpoch(
      program.endTime * 1000,
    );
    
    // yyyyMMddHHmmss æ ¼å¼
    result = result.replaceAll(
      r'${(b)yyyyMMddHHmmss}',
      formatDateTime(startDateTime, 'yyyyMMddHHmmss'),
    );
    result = result.replaceAll(
      r'${(e)yyyyMMddHHmmss}',
      formatDateTime(endDateTime, 'yyyyMMddHHmmss'),
    );
    
    // UTC æ ¼å¼
    result = result.replaceAll(
      r'${(b)yyyyMMddHHmmss:utc}',
      formatDateTime(startDateTime.toUtc(), 'yyyyMMddHHmmss'),
    );
    result = result.replaceAll(
      r'${(e)yyyyMMddHHmmss:utc}',
      formatDateTime(endDateTime.toUtc(), 'yyyyMMddHHmmss'),
    );
    
    // ç®€åŒ– UTC æ ¼å¼
    result = result.replaceAll(
      '{utc:YmdHMS}',
      formatDateTime(startDateTime.toUtc(), 'yyyyMMddHHmmss'),
    );
    result = result.replaceAll(
      '{utcend:YmdHMS}',
      formatDateTime(endDateTime.toUtc(), 'yyyyMMddHHmmss'),
    );
    
    // æŒç»­æ—¶é—´
    result = result.replaceAll(
      r'${duration}',
      program.duration.toString(),
    );
    
    return result;
  }
  
  String formatDateTime(DateTime dt, String format) {
    if (format == 'yyyyMMddHHmmss') {
      return '${dt.year}'
          '${dt.month.toString().padLeft(2, '0')}'
          '${dt.day.toString().padLeft(2, '0')}'
          '${dt.hour.toString().padLeft(2, '0')}'
          '${dt.minute.toString().padLeft(2, '0')}'
          '${dt.second.toString().padLeft(2, '0')}';
    }
    // å…¶ä»–æ ¼å¼...
    return dt.toIso8601String();
  }
}
```

