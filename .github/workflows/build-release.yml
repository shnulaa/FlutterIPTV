name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # ä»…åœ¨æŽ¨é€tagæ—¶è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  FLUTTER_VERSION: '3.38.5'

jobs:
  # ============================================
  # Build Windows Application
  # ============================================
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build Windows Release
        run: flutter build windows --release
      
      - name: Download SQLite3 DLL
        run: |
          $urls = @(
            "https://www.sqlite.org/2025/sqlite-dll-win-x64-3510100.zip",
            "https://www.sqlite.org/2024/sqlite-dll-win-x64-3470200.zip"
          )
          foreach ($url in $urls) {
            try {
              Invoke-WebRequest -Uri $url -OutFile "sqlite3.zip" -TimeoutSec 30
              Expand-Archive -Path "sqlite3.zip" -DestinationPath "sqlite3_temp" -Force
              if (Test-Path "sqlite3_temp/sqlite3.dll") {
                Copy-Item "sqlite3_temp/sqlite3.dll" "build/windows/x64/runner/Release/" -Force
                break
              }
            } catch { continue }
          }
        shell: pwsh
      
      - name: Create Installer
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          if (!$version) { $version = "1.0.0" }
          @"
          [Setup]
          AppName=FlutterIPTV
          AppVersion=$version
          AppPublisher=FlutterIPTV
          DefaultDirName={autopf}\FlutterIPTV
          DefaultGroupName=FlutterIPTV
          OutputDir=.
          OutputBaseFilename=flutteriptv-Windows-x64-Setup
          Compression=lzma2
          SolidCompression=yes
          ArchitecturesInstallIn64BitMode=x64
          PrivilegesRequired=lowest
          [Files]
          Source: "build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs
          [Icons]
          Name: "{group}\FlutterIPTV"; Filename: "{app}\flutter_iptv.exe"
          Name: "{autodesktop}\FlutterIPTV"; Filename: "{app}\flutter_iptv.exe"; Tasks: desktopicon
          [Tasks]
          Name: "desktopicon"; Description: "Create desktop shortcut"; GroupDescription: "Additional icons:"
          [Run]
          Filename: "{app}\flutter_iptv.exe"; Description: "Launch FlutterIPTV"; Flags: nowait postinstall skipifsilent
          "@ | Out-File "installer.iss" -Encoding UTF8
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
        shell: pwsh
      
      - name: Create Portable ZIP
        run: |
          # Create portable marker file
          "This is a portable version. Data will be stored in the application directory." | Out-File "build/windows/x64/runner/Release/portable.txt" -Encoding UTF8
          
          # Create README for portable version
          @"
          FlutterIPTV Portable Version
          =============================
          
          This is a portable version that does not require installation.
          
          Usage:
          1. Extract all files to any folder
          2. Run flutter_iptv.exe
          3. All data will be stored in the application directory
          
          Note: This version is suitable for USB drives or environments without admin rights.
          
          ---
          
          FlutterIPTV ä¾¿æºç‰ˆ
          ==================
          
          è¿™æ˜¯ä¸€ä¸ªæ— éœ€å®‰è£…çš„ä¾¿æºç‰ˆæœ¬ã€‚
          
          ä½¿ç”¨æ–¹æ³•ï¼š
          1. è§£åŽ‹æ‰€æœ‰æ–‡ä»¶åˆ°ä»»æ„æ–‡ä»¶å¤¹
          2. è¿è¡Œ flutter_iptv.exe
          3. æ‰€æœ‰æ•°æ®å°†ä¿å­˜åœ¨ç¨‹åºç›®å½•ä¸­
          
          æ³¨æ„ï¼šæ­¤ç‰ˆæœ¬é€‚åˆUç›˜æºå¸¦æˆ–æ— ç®¡ç†å‘˜æƒé™çš„çŽ¯å¢ƒä½¿ç”¨ã€‚
          "@ | Out-File "build/windows/x64/runner/Release/README.txt" -Encoding UTF8
          
          # Create ZIP package
          Compress-Archive -Path "build/windows/x64/runner/Release/*" `
                           -DestinationPath "flutteriptv-Windows-x64-Portable.zip" `
                           -CompressionLevel Optimal
          
          Write-Host "âœ… Portable ZIP created successfully"
        shell: pwsh
      
      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: |
            flutteriptv-Windows-x64-Setup.exe
            flutteriptv-Windows-x64-Portable.zip
          retention-days: 5

  # ============================================
  # Build All Android APKs (Mobile + TV)
  # ============================================
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Setup Android Signing
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/release-key.jks
          cat > android/key.properties << EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=release-key.jks
          EOF
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build Mobile APKs
        run: |
          flutter clean
          flutter build apk --release --split-per-abi
          mkdir -p dist
          cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk dist/flutteriptv-Android-Mobile-arm64-v8a.apk
          cp build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk dist/flutteriptv-Android-Mobile-armeabi-v7a.apk
          cp build/app/outputs/flutter-apk/app-x86_64-release.apk dist/flutteriptv-Android-Mobile-x86_64.apk
      
      - name: Build TV APKs
        run: |
          flutter clean
          flutter build apk --release --dart-define=IS_TV=true --split-per-abi
          cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk dist/flutteriptv-AndroidTV-arm64-v8a.apk
          cp build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk dist/flutteriptv-AndroidTV-armeabi-v7a.apk
          cp build/app/outputs/flutter-apk/app-x86_64-release.apk dist/flutteriptv-AndroidTV-x86_64.apk
      
      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: dist/
          retention-days: 5

  # ============================================
  # Create GitHub Release
  # ============================================
  create-release:
    name: Create Release
    needs: [build-windows, build-android]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./release-assets/
      
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "TAG=v${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "CREATE_RELEASE=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
            echo "CREATE_RELEASE=true" >> $GITHUB_OUTPUT
          else
            echo "VERSION=dev-build" >> $GITHUB_OUTPUT
            echo "TAG=dev-build" >> $GITHUB_OUTPUT
            echo "CREATE_RELEASE=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate Release Notes
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          TAG="${{ steps.version.outputs.TAG }}"
          BASE_URL="https://github.com/${{ github.repository }}/releases/download/${TAG}"
          
          # Read changelog from version.json
          if [ -f "docs/version.json" ]; then
            CHANGELOG_ZH=$(jq -r '.changelog.zh' docs/version.json)
            CHANGELOG_EN=$(jq -r '.changelog.en' docs/version.json)
          else
            # Fallback to git commits if version.json not found
            PREV_TAG=$(git tag -l 'v*' --sort=-v:refname | grep -v "^${TAG}$" | head -1)
            if [ -n "$PREV_TAG" ]; then
              CHANGELOG_ZH=$(git log --pretty=format:"- %s" ${PREV_TAG}..${TAG} 2>/dev/null | grep -v "^- Merge" || echo "- Bug fixes and improvements")
              CHANGELOG_EN="${CHANGELOG_ZH}"
            else
              CHANGELOG_ZH="- åˆå§‹ç‰ˆæœ¬"
              CHANGELOG_EN="- Initial release"
            fi
          fi
          
          cat > release_notes.md << EOF
          ## ðŸ“º FlutterIPTV ${VERSION}
          
          ### ðŸ“ æ›´æ–°å†…å®¹ What's New
          
          **ä¸­æ–‡ Chinese:**
          ${CHANGELOG_ZH}
          
          **English:**
          ${CHANGELOG_EN}
          
          ---
          
          ### âš ï¸ é‡è¦å£°æ˜Ž Important Notice
          
          **ä¸­æ–‡ï¼š**
          
          æœ¬è½¯ä»¶ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œè¯·å‹¿ç”¨äºŽå•†ä¸šç”¨é€”ã€‚
          
          - æœ¬è½¯ä»¶ä¸æä¾›ä»»ä½•è§†é¢‘å†…å®¹ï¼Œæ‰€æœ‰å†…å®¹å‡æ¥è‡ªç”¨æˆ·è‡ªè¡Œæ·»åŠ çš„æ’­æ”¾åˆ—è¡¨
          - ç”¨æˆ·éœ€è‡ªè¡Œæ‰¿æ‹…ä½¿ç”¨æœ¬è½¯ä»¶è§‚çœ‹å†…å®¹çš„æ³•å¾‹è´£ä»»
          - è¯·éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„ï¼Œæ”¯æŒæ­£ç‰ˆå†…å®¹
          - æœ¬è½¯ä»¶ä½¿ç”¨å¼€æºå­—ä½“ï¼ˆæ€æºé»‘ä½“ï¼‰ï¼Œä¸åŒ…å«ä»»ä½•ä¾µæƒå­—ä½“
          
          **English:**
          
          This software is for learning and communication purposes only. Do not use it for commercial purposes.
          
          - This software does not provide any video content. All content comes from playlists added by users themselves
          - Users are responsible for the legal consequences of using this software to watch content
          - Please comply with local laws and regulations and support genuine content
          - This software uses open source fonts (Source Han Sans) and does not contain any infringing fonts
          
          ---
          
          ### ðŸ“¥ ä¸‹è½½ Downloads
          
          #### ðŸ–¥ï¸ Windows
          | æ–‡ä»¶ File | è¯´æ˜Ž Description |
          |------|------|
          | [flutteriptv-Windows-x64-Setup.exe](${BASE_URL}/flutteriptv-Windows-x64-Setup.exe) | Windows 64ä½å®‰è£…åŒ… (Installer) |
          | [flutteriptv-Windows-x64-Portable.zip](${BASE_URL}/flutteriptv-Windows-x64-Portable.zip) | Windows 64ä½ä¾¿æºç‰ˆ (Portable, no installation required) |
          
          **ä¾¿æºç‰ˆè¯´æ˜Ž Portable Version Notes:**
          - âœ… æ— éœ€å®‰è£…ï¼Œè§£åŽ‹å³ç”¨ No installation required, extract and run
          - âœ… é€‚åˆUç›˜æºå¸¦ Suitable for USB drives
          - âœ… æ•°æ®ä¿å­˜åœ¨ç¨‹åºç›®å½• Data stored in application directory
          - âœ… æ— éœ€ç®¡ç†å‘˜æƒé™ No admin rights required
          
          #### ðŸ“± Android æ‰‹æœºç‰ˆ Mobile
          | æ–‡ä»¶ File | è¯´æ˜Ž Description |
          |------|------|
          | [flutteriptv-Android-Mobile-arm64-v8a.apk](${BASE_URL}/flutteriptv-Android-Mobile-arm64-v8a.apk) | 64ä½ ARM è®¾å¤‡ï¼ˆæŽ¨è Recommendedï¼‰ |
          | [flutteriptv-Android-Mobile-armeabi-v7a.apk](${BASE_URL}/flutteriptv-Android-Mobile-armeabi-v7a.apk) | 32ä½ ARM è®¾å¤‡ 32-bit ARM devices |
          | [flutteriptv-Android-Mobile-x86_64.apk](${BASE_URL}/flutteriptv-Android-Mobile-x86_64.apk) | x86_64 æ¨¡æ‹Ÿå™¨ Emulator |
          
          #### ðŸ“º Android TV ç”µè§†ç‰ˆ
          | æ–‡ä»¶ File | è¯´æ˜Ž Description |
          |------|------|
          | [flutteriptv-AndroidTV-arm64-v8a.apk](${BASE_URL}/flutteriptv-AndroidTV-arm64-v8a.apk) | 64ä½ ARM ç”µè§†ï¼ˆæŽ¨è Recommendedï¼‰ |
          | [flutteriptv-AndroidTV-armeabi-v7a.apk](${BASE_URL}/flutteriptv-AndroidTV-armeabi-v7a.apk) | 32ä½ ARM ç”µè§† 32-bit ARM TV |
          | [flutteriptv-AndroidTV-x86_64.apk](${BASE_URL}/flutteriptv-AndroidTV-x86_64.apk) | x86_64 ç”µè§†æ¨¡æ‹Ÿå™¨ TV Emulator |
          
          ---
          
          ### ðŸ“– ä½¿ç”¨è¯´æ˜Ž Usage Guide
          
          1. **æ·»åŠ æ’­æ”¾åˆ—è¡¨ Add Playlist**: è®¾ç½® â†’ æ’­æ”¾åˆ—è¡¨ç®¡ç† â†’ æ·»åŠ  M3U/M3U8 é“¾æŽ¥
          2. **è§‚çœ‹ç›´æ’­ Watch Live**: é€‰æ‹©é¢‘é“å³å¯æ’­æ”¾
          3. **æ”¶è—é¢‘é“ Favorite**: é•¿æŒ‰é¢‘é“æ·»åŠ åˆ°æ”¶è—å¤¹
          4. **å¤šå±æ’­æ”¾ Multi-screen** (Desktop/TV): æ”¯æŒ2x2åˆ†å±åŒæ—¶è§‚çœ‹4ä¸ªé¢‘é“
          
          ### ðŸ› é—®é¢˜åé¦ˆ Bug Report
          
          å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) é¡µé¢åé¦ˆã€‚
          If you encounter any problems, please report them on the [Issues](https://github.com/${{ github.repository }}/issues) page.
          EOF
      
      - name: Create Release
        if: steps.version.outputs.CREATE_RELEASE == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: flutteriptv ${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            release-assets/windows-release/flutteriptv-Windows-x64-Setup.exe
            release-assets/windows-release/flutteriptv-Windows-x64-Portable.zip
            release-assets/android-release/flutteriptv-Android-Mobile-arm64-v8a.apk
            release-assets/android-release/flutteriptv-Android-Mobile-armeabi-v7a.apk
            release-assets/android-release/flutteriptv-Android-Mobile-x86_64.apk
            release-assets/android-release/flutteriptv-AndroidTV-arm64-v8a.apk
            release-assets/android-release/flutteriptv-AndroidTV-armeabi-v7a.apk
            release-assets/android-release/flutteriptv-AndroidTV-x86_64.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Complete (No Release)
        if: steps.version.outputs.CREATE_RELEASE == 'false'
        run: |
          echo "âœ… Build completed successfully!"
          echo "ðŸ“¦ Artifacts created but no release published (branch push)"
          echo "ðŸ·ï¸ To create a release, push a tag (v1.0.0) or use workflow_dispatch"
